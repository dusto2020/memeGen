<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Erstelle dein Meme</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>MemeGen - The Meme Generator</h1>
    </div>

    <div class="inputForms">
        <div class="inputDuo">
            <label for="link">
                Bild URL/Adresse:
            </label>
            <input id="link" type="url"
                   pattern="((http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png))|(data:[\w]+\/[\w]+(;charset=[\w])?;[\w]+,.+)"
                   onkeyup="EnableDisable()"
                   required>
        </div>

        <p style="text-align: center">
            oder
        </p>

        <div class="inputFile">
            <input id="fileUpload" accept="image/*" onchange="EnableDisable()" type="file"/>
            <label for="fileUpload" class="fileUpload">Bild hochladen</label>
        </div>
        <div class="buttonGrp">
            <button id="delete" type="button" disabled onclick="deleteImg()">Bild l√∂schen</button>
            <button id="submit" type="button" disabled onclick="renderImg()">Bild renderen</button>
        </div>
    </div>

    <div id="memeContainer" class="meme">
        <div id="renderContainer" class="renderContainer">
        </div>

        <div class="textInputs">
            <div class="inputDuo">
                <label for="name">
                    Name des Memes:
                </label>
                <input id="name" type="text">
            </div>

            <div class="inputDuo">
                <label for="textOben">
                    Oberer Text:
                </label>
                <input id="textOben" type="text" onkeyup="renderImg(true)">
            </div>

            <div class="inputDuo">
                <label for="textUnten">
                    Unterer Text:
                </label>
                <input id="textUnten" type="text" onkeyup="renderImg(true)">
            </div>
        </div>
        <div class="saveButtons">
            <button>
                <a id="downloadLink" download>
                    Herunterladen
                </a>
            </button>
            <button>In die Datenbank speichern</button>
        </div>
    </div>

</div>

<script>

    function EnableDisable() {
        let btnSubmit = document.getElementById("submit");
        let url = document.getElementById('link');
        let deleteBtn = document.getElementById("delete");
        let fileUpload = document.getElementById('fileUpload');
        let meme = document.getElementById('memeContainer');
        url.disabled = fileUpload.files.length !== 0;
        fileUpload.disabled = url.value.trim() !== "";
        deleteBtn.disabled = fileUpload.files.length === 0 && document.getElementById('renderCanvas') === null
        btnSubmit.disabled = !url.checkValidity() && fileUpload.files.length === 0;
        meme.style.display = document.getElementById('renderCanvas') ? 'flex' : 'none';
    }


    function renderImg(write = false) {
        let imgURL = document.getElementById("link").value;
        let imgUrlFromFile = document.getElementById("fileUpload").files[0];
        let renderContainer = document.getElementById('renderContainer');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        canvas.id = 'renderCanvas'
        canvas.width = 400 * devicePixelRatio;
        canvas.height = 400 * devicePixelRatio;
        canvas.style.maxWidth = '400px'
        canvas.style.maxHeight = '400px'

        if (renderContainer.childElementCount > 0) {
            renderContainer.replaceChildren();
        }

        if (imgURL === "") {
            let reader = new FileReader();
            reader.readAsDataURL(imgUrlFromFile);
            reader.onload = (e) => {
                canvas = drawCanvas(e.target.result, canvas, ctx, write)
                ctx = canvas.getContext('2d')
                renderContainer.appendChild(canvas)
                EnableDisable();
            }
        } else {
            canvas = drawCanvas(imgURL, canvas, ctx)
            ctx = canvas.getContext('2d')
            renderContainer.appendChild(canvas)
            EnableDisable();
        }
    }

    function drawCanvas(source, canvas, ctx, write = false) {
        let canvasImg = new Image();
        canvasImg.onload = () => {
            if (canvasImg.height >= canvasImg.width) {
                let height = 400 * devicePixelRatio;
                let width = canvasImg.width * (400 / canvasImg.height) * devicePixelRatio
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(canvasImg, (canvas.width / 2) - (width / 2), (canvas.height / 2) - (height / 2), width, height)
                if (write) {
                    writeOnCanvas(canvas, ctx)
                }
            } else {
                let height = canvasImg.height * (400 / canvasImg.width) * devicePixelRatio
                let width = 400 * devicePixelRatio;
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(canvasImg, (canvas.width / 2) - (width / 2), (canvas.height / 2) - (height / 2), width, height)
                if (write) {
                    writeOnCanvas(canvas, ctx)
                }
            }
        }
        canvasImg.src = source;
        return canvas;
    }

    function writeOnCanvas(canvas, ctx) {
        let textOben = document.getElementById('textOben').value.trim()
        let textUnten = document.getElementById('textUnten').value.trim()
        ctx.textAlign = 'center'
        ctx.font = '30pt Arial'
        ctx.fillStyle = '#fff';
        ctx.fillText(textOben, canvas.width / 2, canvas.height * 0.1)
        ctx.fillText(textUnten, canvas.width / 2, canvas.height * 0.9)
        createDownloadLink();
    }

    function createDownloadLink() {
        let canvas = document.getElementById('renderCanvas')
        let link = document.getElementById('downloadLink')
        let memeName = document.getElementById('name').value.trim()
        link.href = canvas.toDataURL();
        link.download = memeName !== "" ? memeName : "MyAwesomeMeme";
    }

    function deleteImg() {
        let renderContainer = document.getElementById('renderContainer');
        let inputFiles = document.getElementById('fileUpload')
        let url = document.getElementById('link');
        let memeName = document.getElementById('name');
        let textOben = document.getElementById('textOben');
        let textUnten = document.getElementById('textUnten');
        url.value = "";
        inputFiles.value = "";
        memeName.value = "";
        textOben.value = "";
        textUnten.value = "";
        renderContainer.replaceChildren();
        EnableDisable()
    }
</script>
</body>
</html>